{% extends "./base.html" %} {% block content %}
<div class="container-fluid py-4">
  <div class="row g-5">
    <div class="col-md-8">
      <!-- Location Selection Section -->
      <div class="card shadow-sm mb-4">
        <div class="card-header text-white" id="card-header-property1">
          <h3 class="mb-0">
            <i class="fas fa-map-marker-alt me-2"></i>Location Selection
          </h3>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <div class="form-group">
                <label for="state-dropdown" class="form-label fw-bold"
                  >State:</label
                >
                <select
                  id="state-dropdown"
                  class="form-select form-select-sm border-primary"
                >
                  <option value="">--Choose a State--</option>
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label for="district-dropdown" class="form-label fw-bold"
                  >District:</label
                >
                <select
                  id="district-dropdown"
                  class="form-select form-select-sm border-primary"
                  disabled
                >
                  <option value="">--Choose a District--</option>
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label for="sub_district-dropdown" class="form-label fw-bold"
                  >Sub-District:</label
                >
                <select
                  id="sub_district-dropdown"
                  class="form-select form-select-sm border-primary"
                  disabled
                >
                  <option value="">--Choose a Sub-District--</option>
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label
                  for="village"
                  id="villageLabel"
                  class="form-label fw-bold"
                  >Village:</label
                >
                <div class="dropdown w-100">
                  <button
                    class="btn btn-outline-primary btn-sm dropdown-toggle w-100"
                    type="button"
                    id="villageDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    --Choose a Village--
                  </button>
                  <ul
                    class="dropdown-menu w-100 p-2 shadow-sm"
                    id="villageCheckboxesContainer"
                    style="
                      max-height: 200px;
                      overflow-y: auto;
                      position: absolute;
                      z-index: 9999;
                    "
                  ></ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Categories Section -->
      <div class="card shadow-sm mb-4">
        <div class="card-header text-white" id="card-header-property2">
          <h3 class="mb-0"><i class="fas fa-list-ul me-2"></i>Categories</h3>
        </div>
        <div class="card-body" id="categories-card">
          <div class="row g-3">
            <div class="col-md-6 border-end">
              <div class="d-grid gap-2">
                <div class="form-check custom-checkbox">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="check1"
                    name="option1"
                  />
                  <label class="form-check-label" for="check1">
                    <i class="fas fa-water text-primary me-2"></i>Sewage Gap
                  </label>
                </div>
                <div class="form-check custom-checkbox">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="check2"
                    name="option2"
                  />
                  <label class="form-check-label" for="check2">
                    <i class="fas fa-temperature-high text-danger me-2"></i>Mean
                    Temperature
                  </label>
                </div>
                <div class="form-check custom-checkbox">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="check3"
                    name="option3"
                  />
                  <label class="form-check-label" for="check3">
                    <i class="fas fa-cloud-rain text-info me-2"></i>Mean
                    Rainfall
                  </label>
                </div>
                <div class="form-check custom-checkbox">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="check4"
                    name="option4"
                  />
                  <label class="form-check-label" for="check4">
                    <i class="fas fa-users text-success me-2"></i>Number of
                    Tourists
                  </label>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-grid gap-2">
                <div class="form-check custom-checkbox">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="check5"
                    name="option5"
                  />
                  <label class="form-check-label" for="check5">
                    <i class="fas fa-landmark text-warning me-2"></i>Number of
                    ASI Sites
                  </label>
                </div>
                <div class="form-check custom-checkbox">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="check6"
                    name="option6"
                  />
                  <label class="form-check-label" for="check6">
                    <i class="fas fa-chart-line text-primary me-2"></i>GDDP at
                    Current Price
                  </label>
                </div>
                <div class="form-check custom-checkbox">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="check7"
                    name="option7"
                  />
                  <label class="form-check-label" for="check7">
                    <i class="fas fa-tint text-info me-2"></i>Water Quality
                    Index
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <button
        type="button"
        id="submit-button1"
        class="btn btn-primary btn-lg w-30 mb-2 shadow-sm"
        onclick="submitForm(event)"
      >
        <!--Submit class="fas fa-search me-2" style="padding: none;"-->Submit
      </button>

      <!-- Table Section -->
      <div class="card shadow-sm mt-4">
        <div class="card-header text-dark" id="results-box-head">
          <h3 class="mb-0"><i class="fas fa-table me-2"></i>Results</h3>
        </div>
        <div class="card-body" id="results-box">
          <div
            class="table-responsive"
            style="max-height: 200px; overflow-y: auto"
          >
            <table class="table table-striped">
              <thead class="table-blue">
                <tr id="headerRow"></tr>
              </thead>
              <tbody id="tableBody">
                <!-- Your table rows go here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <button
        type="button"
        class="btn btn-primary btn-sm m-1 mt-4 text-xl-center"
        id="showBoundariesButton"
        style="
          width: 140px;
          height: 60px;
          font-size: 18px;
          border-radius: 30px;
          background-color: #76ba1b;
          border: none;
        "
        onclick="ranking(event)"
      >
        Ranking
      </button>
    </div>

    <!-- Map Section -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header text-white" id="map-view-header">
          <h3 class="mb-0"><i class="fas fa-map me-2"></i>Map View</h3>
        </div>
        <div
          class="card-body p-0"
          style="border: 1px solid #55565b; border-top: none"
        >
          <div id="map" style="height: calc(100vh - 100px)"></div>
        </div>
      </div>
    </div>
    <canvas id="myBarChart" width="auto" , height="100px"></canvas>
  </div>
</div>

<style>
  #myBarChart {
    display: none;
    /* Hide canvas initially */
  }

  /* Custom Styles */
  .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
  }

  .form-check-label {
    cursor: pointer;
    transform: translateY(-7px);
    font-family: Montserrat;
    padding: 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  /* .form-check-label:hover {
        background-color: #f8f9fa;
    } */

  .form-check-input:checked + .form-check-label {
    background-color: #e9ecef;
  }

  .dropdown-menu {
    max-height: 200px;
    overflow-y: auto;
  }

  .dropdown-item {
    padding: 8px 16px;
  }
  /*
    #state-dropdown, #district-dropdown, #sub_district-dropdown {
        border: none;
        background: #D3D4D9;
    }
*/
  .mb-0 {
    font-size: 22px;
    font-family: Lexend Deca;
    background-color: none;
    color: #55565b;
    padding: 7px 0px 7px 0px;
  }

  #card-header-property1 {
    border-radius: 15px 15px 0px 0px;
    background-color: none;
    border: 1px solid royalblue;
    border-bottom: none;
  }
  #card-header-property2 {
    border-radius: 15px 15px 0px 0px;
    background-color: none;
    border: 1px solid green;
    border-bottom: none;
  }
  .card {
    border: none;
    transition: transform 0.2s ease;
  }

  .card-body {
    border-radius: 0px 0px 15px 15px;
    border: 1px solid royalblue;
    border-top: none;
  }

  #map-view-header {
    background: none;
    border-radius: 15px 15px 0px 0px;
    color: black;
    border: 1px solid #55565b;
    border-bottom: none;
  }
  #submit-button1 {
    font-size: 18px;
    border-radius: 30px;
    border: none;
    overflow: hidden;
    background-color: #76ba1b;
    text-align: center;
    width: 140px;
    height: 60px;
    position: relative;
  }
  #submit-button1:before {
    content: "";
    border-radius: 50%;
    position: absolute;
    overflow: hidden;
    width: 120px;
    height: 120px;
    background-color: white;
    opacity: 0;
    left: 15px;
    top: -29px;
    transform: scale(1.7, 1.7);
    transition: 0.7s;
  }
  #submit-button1:active:before {
    transform: scale(0, 0);
    opacity: 1;
    transition: 0s;
  }
  #categories-card {
    border: 1px solid green;
    border-top: none;
  }
  #results-box-head {
    border: none;
    background: #e0e0e0;
  }

  #results-box {
    border: none;
  }

  /* .card:hover {
        transform: translateY(-2px);
    } */

  .table td.editable {
    position: relative;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .ol-popup {
    background-color: white;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #cccccc;
    bottom: 12px;
    left: -50px;
    min-width: 280px;
  }

  /* .table td.editable:hover {
        background-color: #f8f9fa;
    } */

  .table td.editable::after {
    content: "✎";
    position: absolute;
    right: 8px;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  /* .table td.editable:hover::after {
        opacity: 0.5;
    } */

  /* Animation for loading states */
  .loading {
    position: relative;
    opacity: 0.7;
  }

  .loading::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.2),
      transparent
    );
    animation: loading 1.5s infinite;
  }

  @keyframes loading {
    0% {
      transform: translateX(-100%);
    }

    100% {
      transform: translateX(100%);
    }
  }
</style>
{% endblock %} {% block extra_js %}
<script>
      // Global variables
  let myBarChart;
  let tableData = [];
  let selectedLocation = {
    state: null,
    district: null,
    subDistrict: null,
    villages: [],
  };
  let selectedCategories = [];
  let currentBoundary = null;
  let map;

  // Map initialization
  function initMap() {
    map = L.map("map").setView([20.5937, 78.9629], 5);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors",
    }).addTo(map);
  }

  // Clear existing boundary
  function clearBoundary() {
    if (currentBoundary) {
      map.removeLayer(currentBoundary);
      currentBoundary = null;
    }
    if (map.popup) {
      map.removeLayer(map.popup);
    }
  }

  // Load default boundary
  async function loadDefaultBoundary() {
    try {
      const response = await fetch("/stp/get_boundary/");
      const data = await response.json();

      if (data.coordinates && map) {
        clearBoundary();
        const geojson = {
          type: "Feature",
          geometry: {
            type: "Polygon",
            coordinates: data.coordinates,
          },
        };

        currentBoundary = L.geoJSON(geojson, {
          style: {
            color: "#76ba1b",
            weight: 2,
            opacity: 1,
            fillColor: "#76ba1b",
            fillOpacity: 0.2,
          },
        }).addTo(map);

        map.fitBounds(currentBoundary.getBounds(), {
          padding: [50, 50],
        });
      }
    } catch (error) {
      console.error("Error loading default boundary:", error);
    }
  }

  // Initialize map on page load
  document.addEventListener("DOMContentLoaded", function () {
    // Add Leaflet CSS
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
    document.head.appendChild(link);

    // Add Leaflet JS
    const script = document.createElement("script");
    script.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
    script.onload = function () {
      initMap();
      loadDefaultBoundary();
    };
    document.head.appendChild(script);

    // Initialize form elements and event listeners
    initializeFormElements();
  });

  // Utility Functions
  function getCSRFToken() {
    return document.querySelector("[name=csrfmiddlewaretoken]")?.value || "";
  }

  function resetDropdown(dropdown) {
    dropdown.innerHTML = '<option value="">--Choose an option--</option>';
    dropdown.disabled = true;
  }

  function populateDropdown(dropdown, items) {
    dropdown.innerHTML = '<option value="">--Choose an option--</option>';
    items.forEach((item) => {
      const option = document.createElement("option");
      option.dataset.state = item.state;
      option.dataset.district = item.district;
      option.dataset.subDistrict = item.subdistrict;
      option.value = item.id;
      option.textContent = item.name;
      dropdown.appendChild(option);
    });
    dropdown.disabled = false;
  }

  async function handleVillageSelection(event) {
  const villageId = event.target.id;
  const villageName = event.target.value;
  
  if (event.target.checked) {
    selectedLocation.villages.push(villageName);
    
    try {
      console.log("Fetching boundary for village:", villageName);
      console.log("Request payload:", {
        village_name: villageName,
        state: selectedLocation.state,
        district: selectedLocation.district,
        sub_district: selectedLocation.subDistrict
      });

      const response = await fetch("/stp/get_village_boundary/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken(),
        },
        body: JSON.stringify({
          village_name: villageName,
          state: selectedLocation.state,
          district: selectedLocation.district,
          sub_district: selectedLocation.subDistrict
        }),
      });

      if (!response.ok) {
        throw new Error(`Failed to fetch village boundary: ${response.statusText}`);
      }

      const boundaryData = await response.json();
      console.log("Received boundary data:", boundaryData);

      if (boundaryData.coordinates) {
        // Ensure coordinates are in the correct format
        let coordinates = boundaryData.coordinates;
        // Check if coordinates need to be wrapped in an extra array level
        if (!Array.isArray(coordinates[0][0])) {
          coordinates = [coordinates];
        }
        
        console.log("Processed coordinates:", coordinates);

        // Create GeoJSON feature
        const geojsonData = {
          type: "Feature",
          geometry: {
            type: "MultiPolygon",
            coordinates: coordinates
          },
          properties: {
            name: villageName
          }
        };
        
        console.log("Created GeoJSON:", geojsonData);

        // Create a new boundary layer
        const villageBoundary = L.geoJSON(geojsonData, {
          style: {
            color: '#76ba1b',
            fillColor: '#76ba1b',
            fillOpacity: 0.2,
            weight: 2
          },
          onEachFeature: (feature, layer) => {
            layer.bindPopup(`
              <div class="ol-popup">
                <h6>${feature.properties.name}</h6>
                <p>State: ${selectedLocation.state}<br>
                District: ${selectedLocation.district}<br>
                Sub-District: ${selectedLocation.subDistrict}</p>
              </div>
            `);
          }
        });

        // Add the boundary to the map
        villageBoundary.addTo(map);
        
        // Store the boundary layer reference
        villageBoundaries.set(villageId, villageBoundary);
        
        // Fit map to the boundary
        const bounds = villageBoundary.getBounds();
        if (bounds.isValid()) {
          console.log("Fitting to bounds:", bounds);
          map.fitBounds(bounds, {
            padding: [50, 50],
            maxZoom: 15
          });
        } else {
          console.warn("Invalid bounds for village boundary");
        }
      } else {
        console.warn("No coordinates found in boundary data");
        throw new Error("No boundary data available for this village");
      }
    } catch (error) {
      console.error("Error handling village boundary:", error);
      alert("Failed to load village boundary. Please try again.");
      selectedLocation.villages = selectedLocation.villages.filter(v => v !== villageName);
      event.target.checked = false;
    }
  } else {
    // Remove village from selected villages array
    selectedLocation.villages = selectedLocation.villages.filter(v => v !== villageName);
    
    // Remove the boundary from the map
    const boundary = villageBoundaries.get(villageId);
    if (boundary) {
      map.removeLayer(boundary);
      villageBoundaries.delete(villageId);
      
      // Update map view if there are other boundaries
      if (villageBoundaries.size > 0) {
        const allBounds = L.latLngBounds([]);
        villageBoundaries.forEach(boundary => {
          allBounds.extend(boundary.getBounds());
        });
        map.fitBounds(allBounds, {
          padding: [50, 50],
          maxZoom: 15
        });
      }
    }
  }
}

  function updateSelectedList() {
    selectedCategories = [];
    for (let i = 1; i <= 7; i++) {
      const checkbox = document.getElementById(`check${i}`);
      if (checkbox.checked) {
        selectedCategories.push(getCategoryName(i));
      }
    }
  }

  function getCategoryName(index) {
    const categories = {
      1: "sewage_gap",
      2: "mean_temperature",
      3: "mean_rainfall",
      4: "number_of_tourists",
      5: "number_of_asi_sites",
      6: "gdp_at_current_prices",
      7: "water_quality_index"
    };
    return categories[index];
  }

  // Form submission and table handling
  async function submitForm(event) {
    event.preventDefault();
    try {
      const response = await fetch("/stp/table/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          main_data: selectedLocation,
          categories: selectedCategories,
        }),
      });
      const tableData = await response.json();
      updateTable(tableData);
    } catch (error) {
      console.error("Error fetching table data:", error);
    }
  }

  // Table Update Logic
  function updateTable(data) {
    tableData = [...data];
    const headerRow = document.getElementById("headerRow");
    const tableBody = document.getElementById("tableBody");

    headerRow.innerHTML = "";
    tableBody.innerHTML = "";

    // Add headers
    Object.keys(data[0] || {}).forEach((key) => {
      const th = document.createElement("th");
      th.textContent = key
        .replace(/_/g, " ")
        .replace(/\b\w/g, (l) => l.toUpperCase());
      headerRow.appendChild(th);
    });

    // Add data rows with editable cells
    data.forEach((row, rowIndex) => {
      const tr = document.createElement("tr");
      Object.entries(row).forEach(([key, value]) => {
        const td = document.createElement("td");
        td.className = "editable";
        td.dataset.field = key;
        td.dataset.rowIndex = rowIndex;
        td.dataset.originalValue = value;

        td.textContent = formatCellValue(value, key);
        addEditableCell(td);
        tr.appendChild(td);
      });
      tableBody.appendChild(tr);
    });
  }

  function formatCellValue(value, field) {
    if (typeof value !== 'number') return value;
    return field.includes("temperature") || field.includes("rainfall")
      ? value.toFixed(2)
      : value.toLocaleString();
  }

  function addEditableCell(cell) {
    cell.addEventListener("dblclick", function(e) {
      if (this.querySelector("input")) return;

      const input = document.createElement("input");
      input.type = "text";
      input.value = this.dataset.originalValue;
      input.className = "form-control";

      const originalContent = this.innerHTML;
      this.innerHTML = "";
      this.appendChild(input);
      input.focus();

      const handleUpdate = () => {
        const newValue = input.value;
        const field = this.dataset.field;
        const rowIdx = parseInt(this.dataset.rowIndex);

        try {
          const processedValue = validateAndProcessValue(newValue, field);
          tableData[rowIdx][field] = processedValue;
          this.dataset.originalValue = processedValue;
          this.textContent = formatCellValue(processedValue, field);
        } catch (error) {
          alert(error.message);
          this.innerHTML = originalContent;
        }
      };

      input.addEventListener("blur", handleUpdate);
      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") input.blur();
      });
    });
  }

  function validateAndProcessValue(value, field) {
    if (field.includes("temperature") || field.includes("rainfall")) {
      if (isNaN(value)) throw new Error("Please enter a valid number");
      return parseFloat(value);
    }
    if (field.includes("tourists") || field.includes("sites") || field.includes("gap")) {
      if (isNaN(value) || !Number.isInteger(Number(value)))
        throw new Error("Please enter a valid whole number");
      return parseInt(value);
    }
    return value;
  }

  // Rankings chart handling
  async function ranking(event) {
    event.preventDefault();
    try {
      const response = await fetch("/stp/get_rankings/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken(),
        },
        body: JSON.stringify({ tableData }),
      });

      if (!response.ok) throw new Error("Network response was not ok");

      const data = await response.json();
      updateBarChart(data);
    } catch (error) {
      console.error("Error during ranking:", error);
      alert("Failed to process ranking. Please try again.");
    }
  }

  function updateBarChart(data) {
    document.getElementById("myBarChart").style.display = "block";
    const ctx = document.getElementById("myBarChart").getContext("2d");

    if (myBarChart) myBarChart.destroy();

    myBarChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: data.map(item => item.name),
        datasets: [{
          label: "Rank",
          data: data.map(item => item.rank),
          backgroundColor: data.map(() => generateRandomColor(0.2)),
          borderColor: data.map(() => generateRandomColor(1)),
          borderWidth: 1,
        }],
      },
      options: {
        responsive: true,
        scales: {
          x: { ticks: { maxRotation: 45, minRotation: 45 } },
          y: { beginAtZero: true },
        },
        plugins: {
          legend: { display: true, position: "top" },
        },
      },
    });
  }

  function generateRandomColor(alpha) {
    const r = Math.floor(Math.random() * 256);
    const g = Math.floor(Math.random() * 256);
    const b = Math.floor(Math.random() * 256);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  // Location dropdowns initialization and handling
  async function initializeLocationDropdowns(stateDropdown, districtDropdown, subDistrictDropdown, villageCheckboxesContainer, showOnMapButton) {
    // Fetch initial states
    try {
      const stateResponse = await fetch("/stp/get_states/");
      const states = await stateResponse.json();
      populateDropdown(stateDropdown, states);
    } catch (error) {
      console.error("Error fetching states:", error);
      alert("Failed to load states. Please refresh the page.");
    }

    // Function to update boundary on map
    async function updateBoundaryOnMap() {
      clearBoundary();
      try {
        const boundaryResponse = await fetch("/stp/get_boundary/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
          },
          body: JSON.stringify({
            state: selectedLocation.state,
            district: selectedLocation.district,
            sub_district: selectedLocation.subDistrict,
            villages: selectedLocation.villages,
          }),
        });

        const boundaryData = await boundaryResponse.json();
        console.log("ans state",boundaryData)
        if (boundaryData.coordinates) {
          currentBoundary = L.polygon(boundaryData.coordinates, {
            color: "blue",
            fillColor: "#30f",
            fillOpacity: 0.2,
          }).addTo(map);

          map.fitBounds(currentBoundary.getBounds());

          currentBoundary
            .bindPopup(`
              State: ${selectedLocation.state || "Not Selected"}<br>
              District: ${selectedLocation.district || "Not Selected"}<br>
              Sub-District: ${selectedLocation.subDistrict || "Not Selected"}<br>
              Villages: ${selectedLocation.villages.join(", ") || "None Selected"}
            `)
            .openPopup();
        }
      } catch (error) {
        console.error("Error fetching boundary:", error);
      }
    }

    // State Dropdown Change Event
    stateDropdown.addEventListener("change", async function() {
      const selectedOption = this.options[this.selectedIndex];
      const state_id = selectedOption.dataset.state;
      selectedLocation.state = this.options[this.selectedIndex].text;

      resetDropdown(districtDropdown);
      resetDropdown(subDistrictDropdown);
      clearBoundary();

      if (!state_id) return;

      try {
        const districtResponse = await fetch("/stp/get_districts/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
          },
          body: JSON.stringify({ state: state_id }),
        });
        const districts = await districtResponse.json();
        populateDropdown(districtDropdown, districts);

        // Update boundary after state selection
        await updateBoundaryOnMap();
      } catch (error) {
        console.error("Error fetching districts:", error);
        alert("Failed to load districts. Please try again.");
      }
    });

    // District Dropdown Change Event
    districtDropdown.addEventListener("change", async function() {
      const selectedOption = this.options[this.selectedIndex];
      const district_id = selectedOption.dataset.district;
      const state_id = selectedOption.dataset.state;
      selectedLocation.district = this.options[this.selectedIndex].text;

      resetDropdown(subDistrictDropdown);
      clearBoundary();

      if (!district_id) return;

      try {
        const subDistrictResponse = await fetch("/stp/get_sub_districts/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
          },
          body: JSON.stringify({ district: district_id, state: state_id }),
        });
        const subDistricts = await subDistrictResponse.json();
        populateDropdown(subDistrictDropdown, subDistricts);

        // Update boundary after district selection
        await updateBoundaryOnMap();
      } catch (error) {
        console.error("Error fetching sub-districts:", error);
        alert("Failed to load sub-districts. Please try again.");
      }
    });

    // Sub-District Dropdown Change Event
    subDistrictDropdown.addEventListener("change", async function() {
      const selectedOption = this.options[this.selectedIndex];
      const sub_dis_id = selectedOption.dataset.subDistrict;
      const district_id = selectedOption.dataset.district;
      const state_id = selectedOption.dataset.state;
      villageCheckboxesContainer.innerHTML = "";
      selectedLocation.subDistrict = this.options[this.selectedIndex].text;

      clearBoundary();

      if (!sub_dis_id) {
        selectedLocation.subDistrict = null;
        await updateBoundaryOnMap();
        return;
      }

      try {
        const villageResponse = await fetch("/stp/get_villages/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
          },
          body: JSON.stringify({
            state: state_id,
            district: district_id,
            sub_district: sub_dis_id,
          }),
        });
        const villages = await villageResponse.json();

        // Create village checkboxes
        villages.forEach((village) => {
          const listItem = document.createElement("li");
          listItem.classList.add("form-check");

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.classList.add("form-check-input");
          checkbox.id = `village-${village.id}`;
          checkbox.value = village.name;

          const label = document.createElement("label");
          label.classList.add("form-check-label");
          label.htmlFor = `village-${village.id}`;
          label.textContent = village.name;

          checkbox.addEventListener("change", handleVillageSelection);

          listItem.appendChild(checkbox);
          listItem.appendChild(label);
          villageCheckboxesContainer.appendChild(listItem);
        });

        // Update boundary after sub-district selection
        await updateBoundaryOnMap();
      } catch (error) {
        console.error("Error fetching villages:", error);
        alert("Failed to load villages. Please try again.");
      }
    });

    // Show Boundaries Button Event
    showOnMapButton.addEventListener("click", async function() {
      clearBoundary();

      try {
        const boundaryResponse = await fetch("/stp/get_boundary/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
          },
          body: JSON.stringify({
            state: selectedLocation.state,
            district: selectedLocation.district,
            sub_district: selectedLocation.subDistrict,
            villages: selectedLocation.villages,
          }),
        });

        const boundaryData = await boundaryResponse.json();

        if (boundaryData.coordinates) {
          currentBoundary = L.polygon(boundaryData.coordinates, {
            color: "blue",
            fillColor: "#30f",
            fillOpacity: 0.2,
          }).addTo(map);

          map.fitBounds(currentBoundary.getBounds());

          currentBoundary
            .bindPopup(`
              State: ${selectedLocation.state || "Not Selected"}<br>
              District: ${selectedLocation.district || "Not Selected"}<br>
              Sub-District: ${selectedLocation.subDistrict || "Not Selected"}<br>
              Villages: ${selectedLocation.villages.join(", ") || "None Selected"}
            `)
            .openPopup();
        } else {
          alert("No boundary data available for the selected location.");
        }
      } catch (error) {
        console.error("Error fetching boundary:", error);
        alert("Failed to fetch location boundary. Please try again.");
      }
    });
  }

  // Initialize form elements and attach event listeners
  function initializeFormElements() {
    const stateDropdown = document.getElementById("state-dropdown");
    const districtDropdown = document.getElementById("district-dropdown");
    const subDistrictDropdown = document.getElementById("sub_district-dropdown");
    const villageCheckboxesContainer = document.getElementById("villageCheckboxesContainer");
    const showOnMapButton = document.getElementById("showOnMapButton");

    // Attach category checkbox listeners
    for (let i = 1; i <= 7; i++) {
      document.getElementById(`check${i}`).addEventListener("change", updateSelectedList);
    }

    // Reset checkboxes
    for (let i = 1; i <= 7; i++) {
      document.getElementById(`check${i}`).checked = false;
    }
    updateSelectedList();

    // Initialize dropdowns and location selection
    initializeLocationDropdowns(stateDropdown, districtDropdown, subDistrictDropdown, villageCheckboxesContainer, showOnMapButton);
  }
</script>
{% endblock %}
