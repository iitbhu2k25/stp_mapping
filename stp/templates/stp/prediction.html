{% extends "./base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row g-5">
        <div class="col-md-8">
            <!-- Location Selection Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-header text-white" id="card-header-property1">
                    <h3 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Location Selection</h3>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="state-dropdown" class="form-label fw-bold">State:</label>
                                <select id="state-dropdown" class="form-select form-select-sm border-primary">
                                    <option value="">--Choose a State--</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="district-dropdown" class="form-label fw-bold">District:</label>
                                <select id="district-dropdown" class="form-select form-select-sm border-primary"
                                    disabled>
                                    <option value="">--Choose a District--</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="sub_district-dropdown" class="form-label fw-bold">Sub-District:</label>
                                <select id="sub_district-dropdown" class="form-select form-select-sm border-primary"
                                    disabled>
                                    <option value="">--Choose a Sub-District--</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="village" id="villageLabel" class="form-label fw-bold">Village:</label>
                                <div class="dropdown w-100">
                                    <button class="btn btn-outline-primary btn-sm dropdown-toggle w-100" type="button"
                                        id="villageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        --Choose a Village--
                                    </button>
                                    <ul class="dropdown-menu w-100 p-2 shadow-sm" id="villageCheckboxesContainer"
                                        style="max-height: 200px; overflow-y: auto; position: absolute; z-index: 9999;">
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categories Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-header   text-white" id="card-header-property2"> 
                    <h3 class="mb-0"><i class="fas fa-list-ul me-2"></i>Categories</h3>
                </div>
                <div class="card-body" id="categories-card">
                    <div class="row g-3">
                        <div class="col-md-6 border-end">
                            <div class="d-grid gap-2">
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input" type="checkbox" id="check1" name="option1">
                                    <label class="form-check-label" for="check1">
                                        <i class="fas fa-water text-primary me-2"></i>Sewage Gap
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input" type="checkbox" id="check2" name="option2">
                                    <label class="form-check-label" for="check2">
                                        <i class="fas fa-temperature-high text-danger me-2"></i>Mean Temperature
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input" type="checkbox" id="check3" name="option3">
                                    <label class="form-check-label" for="check3">
                                        <i class="fas fa-cloud-rain text-info me-2"></i>Mean Rainfall
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input" type="checkbox" id="check4" name="option4">
                                    <label class="form-check-label" for="check4">
                                        <i class="fas fa-users text-success me-2"></i>Number of Tourists
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid gap-2">
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input" type="checkbox" id="check5" name="option5">
                                    <label class="form-check-label" for="check5">
                                        <i class="fas fa-landmark text-warning me-2"></i>Number of ASI Sites
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input" type="checkbox" id="check6" name="option6">
                                    <label class="form-check-label" for="check6">
                                        <i class="fas fa-chart-line text-primary me-2"></i>GDDP at Current Price
                                    </label>
                                </div>
                                <div class="form-check custom-checkbox">
                                    <input class="form-check-input" type="checkbox" id="check7" name="option7">
                                    <label class="form-check-label" for="check7">
                                        <i class="fas fa-tint text-info me-2"></i>Water Quality Index
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="button" id="submit-button1" class="btn btn-primary btn-lg w-30 mb-2 shadow-sm" onclick="submitForm(event)">
                <!--Submit class="fas fa-search me-2" style="padding: none;"-->Submit
            </button>

            <!-- Table Section -->
            <div class="card shadow-sm mt-4">
                <div class="card-header  text-dark" id="results-box-head">
                    <h3 class="mb-0"><i class="fas fa-table me-2"></i>Results</h3>
                </div>
                <div class="card-body" id="results-box">
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-striped">
                            <thead class="table-blue">
                                <tr id="headerRow"></tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- Your table rows go here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-primary btn-sm m-1 mt-4 text-xl-center" id="showBoundariesButton"
                style="width: 140px; height: 60px; font-size: 18px; border-radius: 30px; background-color: #76ba1b; border: none;" onclick="ranking(event)">Ranking</button>
        </div>

        <!-- Map Section -->
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header text-white" id="map-view-header">
                    <h3 class="mb-0"><i class="fas fa-map me-2"></i>Map View</h3>
                </div>
                <div class="card-body p-0" style="border: 1px solid #55565b; border-top: none;">
                    <div id="map" style="height: calc(100vh - 100px);"></div>
                </div>
            </div>
        </div>
        <canvas id="myBarChart" width="auto" , height="100px"></canvas>

    </div>
</div>

<style>
    #myBarChart {
        display: none;
        /* Hide canvas initially */
    }

    /* Custom Styles */
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .form-check-label {
        cursor: pointer;
        transform: translateY(-7px);
        font-family: Montserrat;
        padding: 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    /* .form-check-label:hover {
        background-color: #f8f9fa;
    } */

    .form-check-input:checked+.form-check-label {
        background-color: #e9ecef;
    }

    .dropdown-menu {
        max-height: 200px;
        overflow-y: auto;
    }

    .dropdown-item {
        padding: 8px 16px;
    }
/*
    #state-dropdown, #district-dropdown, #sub_district-dropdown {
        border: none;
        background: #D3D4D9;
    }
*/
    .mb-0 {
        font-size: 22px;
        font-family: Lexend Deca;
        background-color: none;
        color: #55565b;
        padding: 7px 0px 7px 0px
    }

    #card-header-property1 {
        border-radius: 15px 15px 0px 0px;
        background-color: none;
        border: 1px solid royalblue;
        border-bottom: none;
    }
    #card-header-property2 {
        border-radius: 15px 15px 0px 0px;
        background-color: none;
        border: 1px solid green;
        border-bottom: none;
    }
    .card {
        border: none;
        transition: transform 0.2s ease;
    }

    .card-body {
        border-radius: 0px 0px 15px 15px;
        border: 1px solid royalblue;
        border-top: none;
    }

    #map-view-header {
        background: none;
        border-radius: 15px 15px 0px 0px;
        color: black;
        border: 1px solid #55565b;
        border-bottom: none;
    }
    #submit-button1 {
        font-size: 18px;
        border-radius: 30px;
        border: none;
        overflow: hidden;
        background-color: #76ba1b;
        text-align: center;
        width: 140px;
        height: 60px;
        position: relative;
    }
    #submit-button1:before {
        content:"";
        border-radius: 50%;
        position: absolute;
        overflow: hidden;
        width: 120px;
        height: 120px;
        background-color: white;
        opacity: 0;
        left: 15px;
        top: -29px;
        transform: scale(1.7, 1.7);
        transition: 0.7s;
    }
    #submit-button1:active:before {
        transform: scale(0, 0);
        opacity: 1;
        transition: 0s;
    }
    #categories-card {
        border: 1px solid green;
        border-top: none;
    }
    #results-box-head {
        border: none;
        background: #e0e0e0;

    }

    #results-box {
        border: none;
    }

    /* .card:hover {
        transform: translateY(-2px);
    } */

    .table td.editable {
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    /* .table td.editable:hover {
        background-color: #f8f9fa;
    } */

    .table td.editable::after {
        content: '✎';
        position: absolute;
        right: 8px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    /* .table td.editable:hover::after {
        opacity: 0.5;
    } */

    /* Animation for loading states */
    .loading {
        position: relative;
        opacity: 0.7;
    }

    .loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        animation: loading 1.5s infinite;
    }

    @keyframes loading {
        0% {
            transform: translateX(-100%);
        }

        100% {
            transform: translateX(100%);
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let myBarChart;
    let tableData = [];
    let selectedLocation = {
        state: null,
        district: null,
        subDistrict: null,
        villages: []

    };
    let selectedCategories = [];
    let currentBoundary = null;
    let table_value = []

    // Initialize Map
    const map = L.map('map').setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
    }).addTo(map);

    // Utility Functions
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }

    function resetDropdown(dropdown) {
        dropdown.innerHTML = '<option value="">--Choose an option--</option>';
        dropdown.disabled = true;
    }
    function handleVillageSelection(event) {
        const villageName = event.target.id;
        console.log('village  unique id is ', villageName);

        if (event.target.checked) {
            selectedLocation.villages.push(villageName);
        } else {
            selectedLocation.villages = selectedLocation.villages.filter(v => v !== villageName);
        }
    }



    function updateSelectedList() {
        if (document.getElementById('check1').checked) selectedCategories.push('Sewage Gap');
        if (document.getElementById('check2').checked) selectedCategories.push('Mean Temperature');
        if (document.getElementById('check3').checked) selectedCategories.push('Mean Rainfall');
        if (document.getElementById('check4').checked) selectedCategories.push('Number of Tourists');
        if (document.getElementById('check5').checked) selectedCategories.push('Number of ASI Sites');
        if (document.getElementById('check6').checked) selectedCategories.push('GDDP at Current Price');
        if (document.getElementById('check7').checked) selectedCategories.push('Water Quality Index');
    }
    async function submitForm(event) {
        event.preventDefault();
        let selectedCategories = [];
        if (document.getElementById('check1').checked) selectedCategories.push('sewage_gap');
        if (document.getElementById('check2').checked) selectedCategories.push('mean_temperature');
        if (document.getElementById('check3').checked) selectedCategories.push('mean_rainfall');
        if (document.getElementById('check4').checked) selectedCategories.push('number_of_tourists');
        if (document.getElementById('check5').checked) selectedCategories.push('number_of_asi_sites');
        if (document.getElementById('check6').checked) selectedCategories.push('gdp_at_current_prices');
        if (document.getElementById('check7').checked) selectedCategories.push('water_quality_index');
        console.log("selectedCategories before try is ", selectedCategories)
        console.log('before the table is ', selectedLocation)
        try {
            const table_data = await fetch('/stp/table/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(
                    {
                        main_data: selectedLocation,
                        categories: selectedCategories
                    }
                )
            })
            table_value = await table_data.json()
            // upfate_table(table_value)
            updateTable(table_value)
            console.log('table_data', table_value);
        } catch (error) {
            console.log('fetch table error', error)
        }
    }
    function updateTable(data) {
        // Store the initial data
        tableData = [...data];

        const headerRow = document.getElementById('headerRow');
        const tableBody = document.getElementById('tableBody');

        // Clear existing content
        headerRow.innerHTML = '';
        tableBody.innerHTML = '';

        // Add headers
        Object.keys(data[0] || {}).forEach(key => {
            const th = document.createElement('th');
            th.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            headerRow.appendChild(th);
        });

        // Add data rows
        data.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            Object.entries(row).forEach(([key, value]) => {
                const td = document.createElement('td');
                td.className = 'editable';
                td.dataset.field = key;
                td.dataset.rowIndex = rowIndex;
                td.dataset.originalValue = value;

                // Format the value based on the field type
                if (typeof value === 'number') {
                    td.textContent = key.includes('temperature') || key.includes('rainfall')
                        ? value.toFixed(2)
                        : value.toLocaleString();
                } else {
                    td.textContent = value;
                }

                // Add double-click event listener for editing
                td.addEventListener('dblclick', function (e) {
                    if (this.querySelector('input')) return;

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = this.dataset.originalValue;
                    input.className = 'form-control';

                    const originalContent = this.innerHTML;
                    this.innerHTML = '';
                    this.appendChild(input);
                    input.focus();

                    const handleUpdate = () => {
                        const newValue = input.value;
                        const field = this.dataset.field;
                        const rowIdx = parseInt(this.dataset.rowIndex);

                        try {
                            // Validate the input based on field type
                            let processedValue;
                            if (field.includes('temperature') || field.includes('rainfall')) {
                                if (isNaN(newValue)) throw new Error('Please enter a valid number');
                                processedValue = parseFloat(newValue);
                            } else if (field.includes('tourists') || field.includes('sites') || field.includes('gap')) {
                                if (isNaN(newValue) || !Number.isInteger(Number(newValue)))
                                    throw new Error('Please enter a valid whole number');
                                processedValue = parseInt(newValue);
                            } else {
                                processedValue = newValue;
                            }

                            // Update the tableData array
                            tableData[rowIdx][field] = processedValue;

                            // Update the cell display
                            this.dataset.originalValue = processedValue;
                            this.textContent = typeof processedValue === 'number'
                                ? (field.includes('temperature') || field.includes('rainfall')
                                    ? processedValue.toFixed(2)
                                    : processedValue.toLocaleString())
                                : processedValue;

                        } catch (error) {
                            alert(error.message);
                            this.innerHTML = originalContent;
                        }
                    };

                    input.addEventListener('blur', handleUpdate);
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') input.blur();
                    });
                });

                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    }

    async function ranking(event) {
        event.preventDefault();
        console.log(tableData);

        try {
            const response = await fetch('/stp/get_rankings/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ tableData })
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            document.getElementById("myBarChart").style.display = "block";

            const data = await response.json();
            const labels = data.map(item => item.name);
            const ranks = data.map(item => item.rank);

            console.log('ok')
            const ctx = document.getElementById('myBarChart').getContext('2d');
            console.log('okay2')

            // Destroy the previous chart instance if it exists
            if (myBarChart) {
                myBarChart.destroy();
            }
            console.log('delete chart')
            myBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Rank',
                        data: ranks,
                        backgroundColor: ranks.map(() => `rgba(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, 0.2)`),
                        borderColor: ranks.map(() => `rgba(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, 1)`),
                        borderWidth: 1
                    }]

                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            ticks: { maxRotation: 45, minRotation: 45 }
                        },
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' }
                    }
                }
            });

        } catch (error) {
            console.error('Error during ranking:', error);
            alert('Failed to process ranking. Please try again.');
        }
    }
    function populateDropdown(dropdown, items) {
        dropdown.innerHTML = '<option value="">--Choose an option--</option>';
        items.forEach(item => {
            const option = document.createElement('option');
            option.dataset.state = item.state;
            option.dataset.district = item.district;
            option.dataset.subDistrict = item.subdistrict;
            option.value = item.id;
            option.textContent = item.name;
            dropdown.appendChild(option);
        });
        dropdown.disabled = false;
    }

    // Remove existing boundary if any
    function clearBoundary() {
        if (currentBoundary) {
            map.removeLayer(currentBoundary);
            currentBoundary = null;
        }
    }



    document.addEventListener('DOMContentLoaded', function () {
        // Dynamically load Leaflet CSS
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/leaflet@1.7.1/dist/leaflet.css';
        document.head.appendChild(link);

        // Dynamically load Leaflet JS
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/leaflet@1.7.1/dist/leaflet.js';
        script.onload = initializeMap;
        document.head.appendChild(script);
    });

    function initializeMap() {
        const map = L.map('map').setView([20.5937, 7.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
        }).addTo(map);
        // Rest of your map initialization code
    }
    document.addEventListener('DOMContentLoaded', async function () {
        const stateDropdown = document.getElementById('state-dropdown');
        const districtDropdown = document.getElementById('district-dropdown');
        const subDistrictDropdown = document.getElementById('sub_district-dropdown');
        const villageDiv = document.getElementById('village');
        const villageDropdown = document.getElementById('villageDropdown');
        const villageCheckboxesContainer = document.getElementById('villageCheckboxesContainer');
        const showOnMapButton = document.getElementById('showOnMapButton');

        document.getElementById('check1').addEventListener('change', updateSelectedList);
        document.getElementById('check2').addEventListener('change', updateSelectedList);
        document.getElementById('check3').addEventListener('change', updateSelectedList);
        document.getElementById('check4').addEventListener('change', updateSelectedList);
        document.getElementById('check5').addEventListener('change', updateSelectedList);
        document.getElementById('check6').addEventListener('change', updateSelectedList);
        document.getElementById('check7').addEventListener('change', updateSelectedList);
        window.onload = function () {
            document.getElementById('check1').checked = false;
            document.getElementById('check2').checked = false;
            document.getElementById('check3').checked = false;
            document.getElementById('check4').checked = false;
            document.getElementById('check5').checked = false;
            document.getElementById('check6').checked = false;
            document.getElementById('check7').checked = false;

            // Call the function to update the list initially (no categories selected)
            updateSelectedList();
        };

        // Fetch States 
        try {
            const stateResponse = await fetch('/stp/get_states/');
            const states = await stateResponse.json();
            populateDropdown(stateDropdown, states);
        } catch (error) {
            console.error('Error fetching states:', error);
            alert('Failed to load states. Please refresh the page.');
        }

        // State Dropdown Change Event
        stateDropdown.addEventListener('change', async function () {
            const selectedOption = this.options[this.selectedIndex];
            let state_id = selectedOption.dataset.state;
            console.log('state_id', state_id)
            selectedLocation.state = this.options[this.selectedIndex].text;
            resetDropdown(districtDropdown);
            resetDropdown(subDistrictDropdown);
            clearBoundary();

            if (!state_id) return;

            try {
                const districtResponse = await fetch('/stp/get_districts/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ state: state_id })
                });
                const districts = await districtResponse.json();
                populateDropdown(districtDropdown, districts);
            } catch (error) {
                console.error('Error fetching districts:', error);
                alert('Failed to load districts. Please try again.');
            }
        });

        // District Dropdown Change Event
        districtDropdown.addEventListener('change', async function () {
            const selectedOption = this.options[this.selectedIndex];
            const district_id = selectedOption.dataset.district;
            const state_id = selectedOption.dataset.state;
            console.log('district_id', district_id)
            selectedLocation.district = this.options[this.selectedIndex].text;

            resetDropdown(subDistrictDropdown);
            clearBoundary();

            if (!district_id) return;

            try {
                const subDistrictResponse = await fetch('/stp/get_sub_districts/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ district: district_id, state: state_id })
                });
                const subDistricts = await subDistrictResponse.json();
                populateDropdown(subDistrictDropdown, subDistricts);
            } catch (error) {
                console.error('Error fetching sub-districts:', error);
                alert('Failed to load sub-districts. Please try again.');
            }
        });

        // Sub-District Dropdown Change Event
        subDistrictDropdown.addEventListener('change', async function () {
            const selectedOption = this.options[this.selectedIndex];
            const sub_dis_id = selectedOption.dataset.subDistrict;
            const district_id = selectedOption.dataset.district;
            const state_id = selectedOption.dataset.state;
            villageCheckboxesContainer.innerHTML = '';
            console.log('sub_dis_id', sub_dis_id)
            selectedLocation.subDistrict = this.options[this.selectedIndex].text;


            clearBoundary();


            if (!sub_dis_id) return;

            try {
                const villageResponse = await fetch('/stp/get_villages/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ state: state_id, district: district_id, sub_district: sub_dis_id })
                });
                const villages = await villageResponse.json();

                // Create village checkboxes
                const villageList = document.createElement('div');
                console.log('village list is ', villageList)
                villages.forEach(village => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('form-check');

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.classList.add('form-check-input');
                    checkbox.id = `village-${village.id}`;
                    checkbox.value = village.name;

                    const label = document.createElement('label');
                    label.classList.add('form-check-label');
                    label.htmlFor = `village-${village.id}`;
                    label.textContent = village.name;

                    // Add event listener for checkbox changes
                    checkbox.addEventListener('change', handleVillageSelection);

                    listItem.appendChild(checkbox);
                    listItem.appendChild(label);
                    villageCheckboxesContainer.appendChild(listItem);
                });
            } catch (error) {
                console.error('Error fetching villages:', error);
                alert('Failed to load villages. Please try again.');
            }
        });


        // Show Boundaries Button Event
        showOnMapButton.addEventListener('click', async function () {
            // Clear previous boundary
            clearBoundary();

            // Fetch boundary data
            try {
                const boundaryResponse = await fetch('/stp/get_boundary/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        state: selectedLocation.state,
                        district: selectedLocation.district,
                        sub_district: selectedLocation.subDistrict,
                        villages: selectedLocation.villages
                    })
                });

                const boundaryData = await boundaryResponse.json();

                if (boundaryData.coordinates) {
                    // Create polygon boundary
                    currentBoundary = L.polygon(boundaryData.coordinates, {
                        color: 'blue',
                        fillColor: '#30f',
                        fillOpacity: 0.2
                    }).addTo(map);

                    // Fit map to boundary
                    map.fitBounds(currentBoundary.getBounds());

                    // Add popup with location details
                    currentBoundary.bindPopup(`
                        State: ${selectedLocation.state || 'Not Selected'}<br>
                        District: ${selectedLocation.district || 'Not Selected'}<br>
                        Sub-District: ${selectedLocation.subDistrict || 'Not Selected'}<br>
                        Villages: ${selectedLocation.villages.join(', ') || 'None Selected'}
                    `).openPopup();
                } else {
                    alert('No boundary data available for the selected location.');
                }
            } catch (error) {
                console.error('Error fetching boundary:', error);
                alert('Failed to fetch location boundary. Please try again.');
            }
        });
    });
</script>
{% endblock %}